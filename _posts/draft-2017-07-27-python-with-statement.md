


## Конструкция with

Конструкция with используется для оборачивания блока кода менеджером контекста.

Менеджер контекста - это объект, который определяет контекст выполнения операций в конструкции with.
Задача менеджера контекста выполнить определенные операции в начале блока with, и в конце.

Чаще всего, менеджер контекста вызывается с помощью блока with, но может использоваться и вызывая его методы напрямую.

Один из самых распространенных примеров использования конструкции with - работа с файлами.

> Весь код находится в репозитории

Пример открытия файла:
```python
In [1]: with open('r1.txt') as f:
   ...:     for line in f:
   ...:         print(line, end='')
   ...:
```

Именно эта конструкция обычно используется, чтобы открыть файл, что-то сделать с содержимым и затем закрывать файл.

В данном случае, после завершения конструкции with, файл автоматически закроется:
```python
In [1]: with open('r1.txt') as f:
   ...:     for line in f:
   ...:         print(line, end='')
   ...:
...

In [2]: f.closed
Out[2]: True

```

Обратите внимание, что переменная f доступна за пределами конструкции f, так как with не создает отдельного пространства имен, как функция.

Внутри конструкции with происходит следующее:
```python
In [19]: f = open('r1.txt').__enter__()

In [20]: for line in f:
    ...:     print(line, end='')
    ...:
...

In [21]: f.__exit__()

In [23]: f.closed
Out[23]: True

```

Метод ```__enter__``` вызывается в самой конструкции with.
Если в with есть выражение ```as```, результат выполнения метода, присваивается в переменную, которая указана после  ```as```.

Потом выполняются какие-то действия, которые находятся в блоке with.

И в конце вызывается метод ```__exit__```.
В данном случае, этот метод закрывает файл.

В примере с файлом, метод ```__exit__``` гарантирует закрытие файла, независимо от того, было ли исключение в блоке with.


### Генератор и @contextlib.contextmanager

В Python существует целый модуль для работы с менеджерами контекста - contextlib.

Например, в этом модуле находится декоратор @contextlib.contextmanager, который позволяет создавать менеджер контекста из генератора.

Простой пример:
```python
import contextlib

@contextlib.contextmanager
def lines():
    print('-'*10, 'START', '-'*10)
    yield
    print('-'*11, 'END', '-'*11)
```

Генератор должен выдавать только одно значение.
При этом то, что находится до yield, будет выполняться в начале блока with.
А то, что находится после yield - в конце.

Использование функции lines() выглядит таким образом:
```python
with lines():
    print('inside with block')

print('outside')
```

Результат выполнения:
```python
$ python with_simple.py
---------- START ----------
inside with block
----------- END -----------
outside

```

Добавить пример с db и netmiko

### Дополнительные материалы

* [The Python "with" Statement by Example](http://preshing.com/20110920/the-python-with-statement-by-example/)
* [PEP 343 -- The "with" Statement](https://www.python.org/dev/peps/pep-0343/)
